---
title: "now in androidでRoborazziはどのように使われているか"
emoji: "📱"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Android, test, jetpackcompose]
published: false
---

# はじめに

最近、Android のテストについて興味が高まっており色々調べています sanao と申します。
[Roborazzi](https://github.com/takahirom/roborazzi)とは、[@takahirom](https://twitter.com/new_runnable)氏によって開発されているスクリーンショットテストライブラリです(私も地味に Contribute してるぜ)。
その有用性から、[now in android](https://github.com/android/nowinandroid) にも 2023 年夏ごろに採用されました[^1]。
本記事では now in android 内で Roborazzi がどのように使われているのかざっくりと説明します。
なお、まだまだ now in android では Roborazzi の導入が進むことが予想されますので、執筆時点(2024/2/6)での情報だということにご注意ください。

### 本記事では説明しないこと

- Roborazzi を採用するメリット
- Roborazzi の使い方

# 使用箇所

現在、Roborazzi が配置されているモジュールは

- core/testing
- core/designsystem
- app
- feature/foryou

になります。

## core/testing

core/testing では、スクリーンショットをシュッと撮るためのヘルパー関数などが実装されています。
もっともよく使用されている関数が`captureMultiTheme`です。
https://github.com/android/nowinandroid/blob/3ff5d48f3739c2341bfb288779e35ff444015783/core/testing/src/main/kotlin/com/google/samples/apps/nowinandroid/core/testing/util/ScreenshotHelper.kt#L94-L101
`captureMultiTheme`は

- 出力するスクリーンショットのファイル名
- ダークモードか
- ダイナミックカラーを使うか
- Android テーマを使うか

を引数を変えるだけで柔軟にスクリーンショットを撮影することができます。

また、現状の使用頻度は少ないですが、デバイスごとにスクリーンショットを取得する関数もあります。
まず、ただひとつのデバイスでスクリーンショットを撮影するための`captureForDevice`関数が実装されています。
https://github.com/android/nowinandroid/blob/3ff5d48f3739c2341bfb288779e35ff444015783/core/testing/src/main/kotlin/com/google/samples/apps/nowinandroid/core/testing/util/ScreenshotHelper.kt#L61-L68

`captureForDevice`の引数`deviceSpec: String` は次のように使うといいでしょう。

```kotlin
composeTestRule.captureForDevice(
            deviceName = "phone_dark",
            deviceSpec = DefaultTestDevices.PHONE.spec,
            ...
```

`DefaultTestDevices` 列挙型はあらかじめ定義してあるスマホ、折りたたみデバイス、タブレットの高さや幅などのスペックです。
以下のように定義されています。
https://github.com/android/nowinandroid/blob/3ff5d48f3739c2341bfb288779e35ff444015783/core/testing/src/main/kotlin/com/google/samples/apps/nowinandroid/core/testing/util/ScreenshotHelper.kt#L47-L51

また、`DefaultTestDevices` を用いてスマホ、折りたたみデバイス、タブレットの全てのスクリーンショットを撮影する関数 `captureMultiDevice` も実装されています。
https://github.com/android/nowinandroid/blob/3ff5d48f3739c2341bfb288779e35ff444015783/core/testing/src/main/kotlin/com/google/samples/apps/nowinandroid/core/testing/util/ScreenshotHelper.kt#L52-L59

## app

[NiaAppScreenSizesScreenshotTests.kt](https://github.com/android/nowinandroid/blob/3ff5d48f3739c2341bfb288779e35ff444015783/app/src/testDemo/kotlin/com/google/samples/apps/nowinandroid/ui/NiaAppScreenSizesScreenshotTests.kt) にて使用されています。
テーマは関係なく、ひたすら色んな幅や高さのスクリーンショットを撮っています。
ここで`captureMultiDevice`を使わなかった理由としては３つのデバイスのスペックだけでなくいろいろな高さや幅のスクリーンショットを撮影するためだと考えられます。

# 脚注

[^1]: 該当 [PR](https://github.com/android/nowinandroid/pull/876)
