---
title: "Now in Android におけるネットワーク接続の監視"
emoji: "🌐"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Android", "nowinandroid", "network"]
published: false
---

# はじめに

昨今の Android アプリはローカルだけで完結せず、インターネットに接続してサーバーからデータを取得することがほとんどだと思います。
ふと、アプリ側でインターネットに接続しているかどうかどうやってチェックしているんだろうと思い、[Now in Android](https://github.com/android/nowinandroid)を題材にして調査してみました。
すると、知見が多く得られたので共有します。

# インターネットに接続していないときの挙動

Now in Android ではインターネットに接続されていないとき、以下のようなスナックバーが表示されます。
![](/images/snackbar.png)
コードのどの部分で制御しているのでしょうか

# 概要

## isOffline

スナックバーの部分の実装は以下の部分になります
https://github.com/android/nowinandroid/blob/f64f1c0aa2b885b0583dd04a5b4055a8952a2b6e/app/src/main/kotlin/com/google/samples/apps/nowinandroid/ui/NiaApp.kt#L112-L123
`isOffline`という変数を用いてネットワークの接続状況を監視し、オフラインになったらスナックバーを表示させていることが分かります。では、さらに`isOffline`の実装を見てみましょう。
https://github.com/android/nowinandroid/blob/f64f1c0aa2b885b0583dd04a5b4055a8952a2b6e/app/src/main/kotlin/com/google/samples/apps/nowinandroid/ui/NiaAppState.kt#L106-L112
`networkMonitor.isOnline`の型は`Flow<Boolean>`(後で詳細に説明します)です。
なのでインターネットに繋がっていたら川の流れのように`true`が流れてくるイメージです。
これを Hot な StateFlow に変換して常に最新の状態を監視しています。
